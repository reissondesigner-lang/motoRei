<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MotoPanel PRO +</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background: #050505; color: #00ff41; font-family: 'Orbitron', sans-serif; }
        .lcd-panel { background: linear-gradient(145deg, #101010, #050505); border: 1px solid #222; box-shadow: inset 0 0 30px #000; }
        .fuel-bar { transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.1; } }
        input[type="number"] { font-family: sans-serif; color: white; border-radius: 12px; }
        .history-card { font-family: sans-serif; background: #111; border-left: 3px solid #eab308; }
    </style>
</head>
<body class="p-4 flex flex-col min-h-screen max-w-md mx-auto">
    
    <div class="lcd-panel p-5 rounded-[2rem] mb-6 shadow-2xl">
        <div class="flex justify-between items-start mb-2">
            <div>
                <span class="text-[9px] text-gray-500 block uppercase tracking-tighter">Total ODO</span>
                <span id="dispTotalKm" class="text-3xl font-bold text-white leading-none">000000</span> <span class="text-[10px] text-green-500">km</span>
            </div>
            <div class="text-right">
                <span class="text-[9px] text-gray-500 block uppercase tracking-tighter">Consumo Médio</span>
                <span id="dispMedia" class="text-2xl font-bold text-yellow-500">0.0</span> <span class="text-[10px]">km/L</span>
            </div>
        </div>

        <div class="mb-4">
            <div class="w-full bg-gray-950 h-5 rounded-full border border-gray-800 p-1 flex overflow-hidden">
                <div id="fuelBar" class="fuel-bar h-full rounded-full bg-green-500 w-0"></div>
            </div>
            <div class="flex justify-between mt-2 items-baseline">
                <span id="dispAutonomia" class="text-xs font-bold text-gray-400 italic">Autonomia: -- km</span>
                <span id="dispLitros" class="text-lg font-bold text-white">0.0<span class="text-xs text-gray-500">/4.5L</span></span>
            </div>
        </div>

        <div class="border-t border-gray-900 pt-3 flex justify-between items-center">
            <div class="flex flex-col">
                <span class="text-[9px] text-gray-500 uppercase">Óleo vence em:</span>
                <span id="dispOleo" class="text-sm font-bold">---</span>
            </div>
            <div id="oilAlert" class="hidden blink bg-red-950 text-red-500 px-2 py-1 rounded text-[10px] font-bold border border-red-800 uppercase">Trocar Óleo!</div>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-3 mb-6">
        <div class="grid grid-cols-2 gap-2">
            <input type="number" id="inKm" placeholder="KM Atual" class="bg-gray-900 p-4 border border-gray-800 outline-none focus:border-green-600">
            <input type="number" id="inLitros" placeholder="Litros" class="bg-gray-900 p-4 border border-gray-800 outline-none focus:border-orange-600">
        </div>
        
        <div class="flex gap-2">
            <label class="flex flex-1 items-center justify-center bg-gray-900 rounded-xl border border-gray-800 p-3 select-none active:bg-gray-800">
                <span class="text-xs mr-3 uppercase text-gray-400">Enchi o tanque?</span>
                <input type="checkbox" id="inCheio" class="w-6 h-6 rounded accent-green-600">
            </label>
            <button onclick="handleAction('abastecer')" class="flex-1 bg-orange-600 text-white font-bold rounded-xl uppercase text-xs">Abastecer</button>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <button onclick="handleAction('km')" class="bg-gray-800 text-gray-300 font-bold p-3 rounded-xl uppercase text-[10px]">Apenas Atualizar KM</button>
            <button onclick="handleAction('oleo')" class="bg-blue-800 text-white font-bold p-3 rounded-xl uppercase text-[10px]">Troquei Óleo</button>
        </div>
    </div>

    <div class="flex-grow">
        <h3 class="text-[10px] text-gray-500 uppercase mb-2 tracking-widest px-1">Últimos Abastecimentos</h3>
        <div id="historico" class="space-y-2">
            </div>
    </div>

    <script>
        const CAP_MAX = 4.5;
        const INT_OLEO_KM = 1000;
        const INT_OLEO_DIAS = 90;

        let db = JSON.parse(localStorage.getItem('motoDB')) || {
            km: 0,
            kmOleo: 0,
            dataOleo: Date.now(),
            litrosNoTanque: 0,
            historico: [], // {km, litros, cheio, data}
            mediaSugerida: 35
        };

        function render() {
            // Update Odometro
            document.getElementById('dispTotalKm').innerText = Math.floor(db.km).toString().padStart(6, '0');
            
            // Lógica de Óleo
            const kmRestante = INT_OLEO_KM - (db.km - db.kmOleo);
            const diasVencimento = db.dataOleo + (INT_OLEO_DIAS * 86400000);
            const diasRestantes = Math.ceil((diasVencimento - Date.now()) / 86400000);
            
            const oilText = document.getElementById('dispOleo');
            oilText.innerText = `${kmRestante} km ou ${diasRestantes} dias`;
            
            if (kmRestante <= 0 || diasRestantes <= 0) {
                oilText.className = "text-sm font-bold text-red-500";
                document.getElementById('oilAlert').classList.remove('hidden');
            } else {
                oilText.className = "text-sm font-bold text-green-500";
                document.getElementById('oilAlert').classList.add('hidden');
            }

            // Média de Consumo (Baseada nos últimos 3 abastecimentos 'Cheios')
            const abastecimentosCheios = db.historico.filter(h => h.cheio);
            if (abastecimentosCheios.length >= 2) {
                let somaMedias = 0;
                let cont = 0;
                for (let i = 0; i < Math.min(abastecimentosCheios.length - 1, 3); i++) {
                    const atual = abastecimentosCheios[i];
                    const anterior = abastecimentosCheios[i+1];
                    const dist = atual.km - anterior.km;
                    if (dist > 0 && atual.litros > 0) {
                        somaMedias += (dist / atual.litros);
                        cont++;
                    }
                }
                if (cont > 0) db.mediaSugerida = somaMedias / cont;
            }
            document.getElementById('dispMedia').innerText = db.mediaSugerida.toFixed(1);

            // Combustível e Autonomia
            const perc = (db.litrosNoTanque / CAP_MAX) * 100;
            const bar = document.getElementById('fuelBar');
            bar.style.width = `${Math.min(perc, 100)}%`;
            bar.className = `fuel-bar h-full rounded-full ${perc < 25 ? 'bg-red-600 blink' : (perc < 50 ? 'bg-yellow-500' : 'bg-green-600')}`;
            
            document.getElementById('dispLitros').innerText = db.litrosNoTanque.toFixed(1);
            document.getElementById('dispAutonomia').innerText = `Autonomia: ${(db.litrosNoTanque * db.mediaSugerida).toFixed(0)} km`;

            // Render Histórico
            const histContainer = document.getElementById('historico');
            histContainer.innerHTML = db.historico.slice(0, 5).map(h => `
                <div class="history-card p-3 rounded-lg flex justify-between items-center text-white">
                    <div>
                        <div class="text-[10px] text-gray-500">${new Date(h.data).toLocaleDateString()}</div>
                        <div class="text-sm font-bold">${h.km} km</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-orange-400">${h.litros.toFixed(2)}L ${h.cheio ? '<b>(Cheio)</b>' : ''}</div>
                        <div class="text-[10px] text-gray-500">Média: ${(h.consumoInst || 0).toFixed(1)} km/L</div>
                    </div>
                </div>
            `).join('');

            localStorage.setItem('motoDB', JSON.stringify(db));
        }

        function handleAction(tipo) {
            const inputKm = parseFloat(document.getElementById('inKm').value);
            const inputLitros = parseFloat(document.getElementById('inLitros').value) || 0;
            const isCheio = document.getElementById('inCheio').checked;

            if (!inputKm) return alert("Por favor, insira o KM atual.");
            if (inputKm < db.km) return alert("O KM não pode ser menor que o atual!");

            // Consumo de combustível desde a última atualização
            const distanciaPercorrida = inputKm - db.km;
            if (db.km > 0) {
                db.litrosNoTanque = Math.max(0, db.litrosNoTanque - (distanciaPercorrida / db.mediaSugerida));
            }
            db.km = inputKm;

            if (tipo === 'abastecer') {
                if (!inputLitros && !isCheio) return alert("Insira os litros ou marque tanque cheio.");
                
                let litrosEfetivos = inputLitros;
                if (isCheio) {
                    litrosEfetivos = CAP_MAX - db.litrosNoTanque;
                    db.litrosNoTanque = CAP_MAX;
                } else {
                    db.litrosNoTanque = Math.min(CAP_MAX, db.litrosNoTanque + inputLitros);
                }

                // Cálculo de consumo instantâneo para o histórico
                let consumoInst = 0;
                if (db.historico.length > 0) {
                    consumoInst = (inputKm - db.historico[0].km) / (litrosEfetivos || 1);
                }

                db.historico.unshift({
                    km: inputKm,
                    litros: litrosEfetivos,
                    cheio: isCheio,
                    data: Date.now(),
                    consumoInst: consumoInst
                });
            } else if (tipo === 'oleo') {
                db.kmOleo = inputKm;
                db.dataOleo = Date.now();
                alert("Troca de óleo registrada!");
            }

            // Limpa inputs
            document.getElementById('inLitros').value = '';
            document.getElementById('inCheio').checked = false;
            
            render();
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        render();
    </script>
</body>
</html>
