<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MotoPanel PRO+</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --neon-green: #00ff41; --dark-bg: #000814; --text-gray: #666; --warning-red: #dc2626; --warning-yellow: #eab308; }

        body { 
            background: var(--dark-bg); color: var(--neon-green); font-family: 'Orbitron', sans-serif; 
            padding: 1rem; display: flex; flex-direction: column; min-height: 100vh; max-width: 32rem; margin: 0 auto;
            font-size: 16px;
        }

        .label-futuristic { font-size: 10px; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.12em; font-weight: 700; margin-bottom: 4px; }

        /* Sessões do Dashboard */
        .session-card { 
            background: linear-gradient(145deg, #000407, #050505); 
            border: 2px solid #1a1a1a; 
            padding: 1.2rem; 
            border-radius: 1.2rem; 
            margin-bottom: 0.75rem; 
            box-shadow: inset 0 0 20px #000;
            position: relative;
        }

        /* 1. Odômetro */
        .odo-container { display: flex; align-items: baseline; gap: 4px; }
        .val-main { color: #fff; font-size: 2.2rem; font-weight: 700; line-height: 1; }
        .val-meters { color: #000; background: #fff; padding: 2px 6px; border-radius: 3px; font-size: 1.8rem; font-weight: 700; margin-left: 4px; line-height: 1; }
        .val-media { color: #eab308; font-size: 1.6rem; font-weight: 700; }

        /* 2. Combustível */
        .fuel-bar-container { width: 100%; background: #000; height: 18px; border-radius: 4px; border: 1px solid #1a1a1a; margin: 8px 0; overflow: hidden; padding: 2px; }
        .fuel-bar { height: 100%; border-radius: 2px; transition: width 0.8s ease; }
        
        /* 3. Óleo */
        .oil-info-row { display: flex; justify-content: space-between; align-items: center; }

        /* Alertas */
        .alert-box { 
            font-size: 14px; font-weight: 700; padding: 10px; border-radius: 8px; 
            text-align: center; text-transform: uppercase; margin-top: 8px; width: 100%;
        }
        .alert-red { background: #450a0a; color: #f87171; border: 1px solid #7f1d1d; }
        .alert-yellow { background: #422006; color: #fbbf24; border: 1px solid #78350f; }

        /* Controles */
        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem; }
        input { 
            background: #0a0a0a; color: #fff; border: 2px solid #222; padding: 1.1rem; 
            border-radius: 0.8rem; font-family: 'Orbitron', sans-serif; font-size: 16px; text-align: center; outline: none; width: 100%;
        }
        input:focus { border-color: var(--neon-green); }

        button { 
            background: #111; color: #ccc; border: 1px solid #333; padding: 1.1rem; 
            border-radius: 0.8rem; font-family: 'Orbitron', sans-serif; font-size: 11px; 
            text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer;
        }
        .btn-abastecer { background: #ea580c; color: #fff; border: none; font-size: 13px; font-weight: 700; }
        .btn-sync { color: var(--neon-green); border-color: #1a1a1a; }
        
        .checkbox-container { display: flex; align-items: center; justify-content: center; background: #0a0a0a; border: 2px solid #222; border-radius: 0.8rem; padding: 0.5rem; }
        input[type="checkbox"] { width: 28px; height: 28px; accent-color: var(--neon-green); margin-left: 10px; }

        .history-card { background: #080808; border-left: 3px solid var(--neon-green); padding: 0.8rem; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <div class="session-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p class="label-futuristic">Kilometragem Total</p>
                <div class="odo-container">
                    <span id="dispTotalKm" class="val-main">00.000</span>
                    <span id="dispMeters" class="val-meters">0</span>
                </div>
            </div>
            <div style="text-align: right;">
                <p class="label-futuristic">Média Real</p>
                <span id="dispMedia" class="val-media">0.0</span><span style="font-size: 10px; color: #555;"> km/L</span>
            </div>
        </div>
    </div>

    <div class="session-card">
        <p class="label-futuristic">Monitor de Combustível</p>
        <div class="fuel-bar-container">
            <div id="fuelBar" class="fuel-bar"></div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span id="dispAutonomia" style="font-size: 13px; color: #fff;">Autonomia: -- km</span>
            <span id="dispLitros" style="color: #fff; font-size: 16px; font-weight: 700;">
                0.00 <span style="color: #444; font-size: 11px;">/ 4.50L</span>
            </span>
        </div>
        <div id="fuelAlertBox" class="alert-box alert-red blink" style="display: none;">⚠ Reserva de Combustível</div>
    </div>

    <div class="session-card">
        <div class="oil-info-row">
            <div>
                <p class="label-futuristic">Troca de Óleo em</p>
                <span id="dispOleo" style="color: #fff; font-size: 14px; font-weight: 700;">---</span>
            </div>
            <div id="oilAlert" class="alert-box blink" style="display: none; margin: 0; width: auto; padding: 6px 12px;"></div>
        </div>
    </div>

    <div class="control-grid">
        <input type="number" step="0.1" inputmode="decimal" id="inKm" placeholder="KM ATUAL">
        <input type="number" step="0.01" inputmode="decimal" id="inLitros" placeholder="LITROS">
    </div>

    <div class="control-grid">
        <div class="checkbox-container">
            <span class="label-futuristic">Tanque Cheio?</span>
            <input type="checkbox" id="inCheio">
        </div>
        <button onclick="abastecer()" class="btn-abastecer">Abastecer</button>
    </div>

    <div class="control-grid" style="margin-bottom: 1.5rem;">
        <button onclick="atualizarApenasKm()" class="btn-sync">Sincronizar KM</button>
        <button onclick="trocarOleo()" style="border-color: #1e3a8a; color: #60a5fa;">Trocar Óleo</button>
    </div>

    <div style="flex-grow: 1;">
        <p class="label-futuristic">Histórico de Abastecimentos</p>
        <div id="historico"></div>
        
        <div class="control-grid" style="margin-top: 1.5rem; opacity: 0.2;">
            <button onclick="exportarBackup()" style="font-size: 8px;">Exportar</button>
            <button onclick="document.getElementById('fileInput').click()" style="font-size: 8px;">Importar</button>
            <input type="file" id="fileInput" style="display: none;" onchange="importarBackup(event)">
        </div>
    </div>

    <script>
        const CAP_MAX = 4.5;
        const LIMITE_RESERVA = 1.5;
        const INT_OLEO_KM = 1000.0;
        const INT_OLEO_DIAS = 90;

        let db = JSON.parse(localStorage.getItem('motoDB_v2')) || {
            km: 0, kmOleo: 0, dataOleo: Date.now(), litrosNoTanque: 0, historico: [], mediaSugerida: 35
        };

        function vibrar(ms = 40) { if (navigator.vibrate) navigator.vibrate(ms); }

        function render() {
            // ODO
            const totalFixo = db.km.toFixed(1);
            const partes = totalFixo.split('.');
            document.getElementById('dispTotalKm').innerText = Math.floor(partes[0]).toLocaleString('pt-BR', { minimumIntegerDigits: 5 });
            document.getElementById('dispMeters').innerText = partes[1] || "0";
            
            // ÓLEO
            const kmRestante = INT_OLEO_KM - (db.km - db.kmOleo);
            const msPassados = Date.now() - db.dataOleo;
            const diasRestantes = INT_OLEO_DIAS - Math.floor(msPassados / (1000 * 60 * 60 * 24));
            document.getElementById('dispOleo').innerText = `${kmRestante.toFixed(1)} km / ${diasRestantes} d`;

            const oilAlertBox = document.getElementById('oilAlert');
            if (kmRestante <= 0 || diasRestantes <= 0) {
                oilAlertBox.style.display = "block";
                oilAlertBox.className = "alert-box alert-red blink";
                oilAlertBox.innerText = "Trocar Óleo!";
            } else if (kmRestante <= 100 || diasRestantes <= 5) {
                oilAlertBox.style.display = "block";
                oilAlertBox.className = "alert-box alert-yellow blink";
                oilAlertBox.innerText = "⚠ Prepara!";
            } else {
                oilAlertBox.style.display = "none";
            }

            // COMBUSTÍVEL
            const perc = (db.litrosNoTanque / CAP_MAX) * 100;
            const bar = document.getElementById('fuelBar');
            bar.style.width = Math.min(perc, 100) + '%';
            
            const isReserva = db.litrosNoTanque < LIMITE_RESERVA;
            const fuelAlertBox = document.getElementById('fuelAlertBox');
            
            bar.style.backgroundColor = isReserva ? 'var(--warning-red)' : 'var(--neon-green)';
            fuelAlertBox.style.display = isReserva ? "block" : "none";
            if(isReserva) bar.classList.add('blink'); else bar.classList.remove('blink');

            document.getElementById('dispLitros').innerText = db.litrosNoTanque.toFixed(2);
            document.getElementById('dispMedia').innerText = db.mediaSugerida.toFixed(1);
            document.getElementById('dispAutonomia').innerText = `Autonomia: ${(db.litrosNoTanque * db.mediaSugerida).toFixed(0)} km`;

            // HISTÓRICO
            const histContainer = document.getElementById('historico');
            histContainer.innerHTML = db.historico.slice(0, 4).map(h => `
                <div class="history-card">
                    <div>
                        <p class="label-futuristic" style="margin:0; color:#444">${new Date(h.data).toLocaleDateString()}</p>
                        <p style="font-size:14px; color:#fff"><b>${h.km.toLocaleString('pt-BR')}</b> km</p>
                    </div>
                    <div style="text-align: right;">
                        <p style="color: #eab308; font-weight: 700; font-size: 14px;">${h.litros.toFixed(2)}L</p>
                        <p class="label-futuristic" style="margin:0">${h.cheio ? 'Cheio' : 'Parcial'}</p>
                    </div>
                </div>
            `).join('');

            localStorage.setItem('motoDB_v2', JSON.stringify(db));
        }

        function atualizarConsumo(novoKm) {
            if (db.km > 0 && novoKm > db.km) {
                const distancia = novoKm - db.km;
                db.litrosNoTanque = Math.max(0, db.litrosNoTanque - (distancia / db.mediaSugerida));
            }
            db.km = novoKm;
        }

        function abastecer() {
            vibrar(60);
            const km = parseFloat(document.getElementById('inKm').value);
            let litrosInput = parseFloat(document.getElementById('inLitros').value) || 0;
            const cheio = document.getElementById('inCheio').checked;

            if (!km || km < db.km) return alert("KM Inválido.");
            atualizarConsumo(km);

            if (cheio && litrosInput === 0) {
                litrosInput = CAP_MAX - db.litrosNoTanque;
            }
            if (litrosInput <= 0 && !cheio) return alert("Informe os litros.");

            if (cheio) {
                const idxUltimoCheio = db.historico.findIndex(h => h.cheio === true);
                if (idxUltimoCheio !== -1) {
                    const ultimoCheio = db.historico[idxUltimoCheio];
                    const distTotal = km - ultimoCheio.km;
                    const litrosParciais = db.historico.slice(0, idxUltimoCheio).reduce((acc, h) => acc + h.litros, 0);
                    const consumoTotal = litrosParciais + litrosInput;
                    if (distTotal > 0 && consumoTotal > 0) {
                        db.mediaSugerida = (db.mediaSugerida * 0.3) + ((distTotal / consumoTotal) * 0.7);
                    }
                }
                db.litrosNoTanque = CAP_MAX;
            } else {
                db.litrosNoTanque = Math.min(CAP_MAX, db.litrosNoTanque + litrosInput);
            }

            db.historico.unshift({ km, litros: litrosInput, cheio, data: Date.now() });
            document.getElementById('inKm').value = '';
            document.getElementById('inLitros').value = '';
            document.getElementById('inCheio').checked = false;
            render();
        }

        function atualizarApenasKm() {
            const km = parseFloat(document.getElementById('inKm').value);
            if (km >= db.km) { atualizarConsumo(km); document.getElementById('inKm').value = ''; render(); vibrar(); }
        }

        function trocarOleo() {
            vibrar(100);
            const km = parseFloat(document.getElementById('inKm').value) || db.km;
            if(confirm("Confirmar troca de óleo e resetar contador?")) {
                db.kmOleo = km;
                db.dataOleo = Date.now();
                render();
            }
        }

        function exportarBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "moto.json"); dl.click();
        }

        function importarBackup(e) {
            const reader = new FileReader();
            reader.onload = (ev) => { db = JSON.parse(ev.target.result); render(); alert("Importado!"); };
            reader.readAsText(e.target.files[0]);
        }

        render();
    </script>
</body>
</html>
