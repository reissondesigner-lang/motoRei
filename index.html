<!DOCTYPE html>
<html lang="pt-br" style="background-color: #000310;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MotoRei PRO+</title>
    <link rel="manifest" href="manifest.json">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --neon-green: #00ff41; --dark-bg: radial-gradient(#000814, #000310); --text-gray: #999; --warning-red: #dc2626; --warning-yellow: #eab308; }

        @font-face {
            font-family: 'Orbitron';
            src: url('orbitron.ttf') format('truetype');
            font-weight: 400 900;
            font-display: swap;
        }

        body { 
            background: var(--dark-bg); color: var(--neon-green); font-family: 'Orbitron', sans-serif; 
            padding: 1rem; display: flex; flex-direction: column; min-height: 100vh; max-width: 32rem; margin: 0 auto;
            font-size: 16px;
            opacity: 0; animation: quickShow 0.3s ease-in forwards;
        }

        @keyframes quickShow { to { opacity: 1; } }

        .label-futuristic { font-size: 10px; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.12em; font-weight: 700; margin-bottom: 4px; }

        .session-card { 
            background: radial-gradient(#000814, #000310); 
            border: 2px solid #1a1a1a; 
            padding: 1.2rem; 
            border-radius: 1.2rem; 
            margin-bottom: 0.3rem; 
            box-shadow: inset 0 0 20px #000;
            position: relative;
        }

        .odo-container { display: flex; align-items: baseline; gap: 4px; }
        .val-main { color: #fff; font-size: 2.2rem; font-weight: 700; line-height: 1; }
        .val-meters { color: #000; background: #fff; padding: 2px 2px; border-radius: 3px; font-size: 1.5rem; font-weight: 700; margin-left: 1px; line-height: 1; }
        .val-media { color: #eab308; font-size: 1.6rem; font-weight: 700; }

        .fuel-bar-container { width: 100%; background: #000; height: 18px; border-radius: 4px; border: 1px solid #1a1a1a; margin: 8px 0; overflow: hidden; padding: 2px; }
        .fuel-bar { height: 100%; border-radius: 2px; transition: width 0.8s ease; }
        
        .oil-info-row { display: flex; justify-content: space-between; align-items: center; }

        .alert-box { 
            font-size: 14px; font-weight: 700; padding: 10px; border-radius: 8px; 
            text-align: center; text-transform: uppercase; margin-top: 8px; width: 100%;
        }
        .alert-red { background: #450a0a; color: #f87171; border: 1px solid #7f1d1d; }
        .alert-yellow { background: #422006; color: #fbbf24; border: 1px solid #78350f; }

        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; margin-bottom: 0.4rem; }
        input { 
            background: #0a0a0a; color: #fff; border: 2px solid #222; padding: 1.1rem; 
            border-radius: 0.8rem; font-family: 'Orbitron', sans-serif; font-size: 16px; text-align: center; outline: none; width: 100%;
        }
        input:focus { border-color: var(--neon-green); }

        button { 
            background: #111; color: #ccc; border: 1px solid #333; padding: 1.1rem; 
            border-radius: 0.8rem; font-family: 'Orbitron', sans-serif; font-size: 11px; 
            text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer;
        }
        .btn-abastecer { background: #ea580c; color: #fff; border: none; font-size: 13px; font-weight: 700; }
        .btn-sync { color: var(--neon-green); border-color: #1a1a1a; }
        
        .checkbox-container { display: flex; align-items: center; justify-content: center; background: #0a0a0a; border: 2px solid #222; border-radius: 0.8rem; padding: 0.5rem; }
        input[type="checkbox"] { width: 28px; height: 28px; accent-color: var(--neon-green); margin-left: 10px; }

        .history-card { background: #080808; border-left: 3px solid var(--neon-green); padding: 0.8rem; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.3; } }
        hr { width:100%; margin: 20px 0; border: 1px solid #1a202c; }
        #fuelGauge {
    filter: drop-shadow(0 0 6px #00ff41);
}
    </style>
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 0 5px;">
    <h1 style="font-size: 1.2rem; letter-spacing: 2px; color: #eab308;">MotoRei <span style="color:#fff">PRO+</span></h1>
    
    <button onclick="baixarBackupOnline()" style="padding: 0.5rem 0.8rem; font-size: 10px; border-color: #eab308; color: #eab308; background: transparent;">
        ‚òÅ sync
    </button>
</div>
    <div class="session-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <p class="label-futuristic">Quilometragem Total</p>
                <div class="odo-container">
                    <span id="dispTotalKm" class="val-main">00.000</span>
                    <span id="dispMeters" class="val-meters">0</span>
                    <span style="font-size: 10px; color: #555;"> km</span>
                </div>
            </div>
            <div style="text-align: right;">
                <p class="label-futuristic">M√©dia Km/l</p>
                <span id="dispMedia" class="val-media">0.0</span>
            </div>
        </div>
    </div>

    <div class="session-card">
        <p class="label-futuristic">N√≠vel de Combust√≠vel</p>
        <div class="fuel-bar-container"><div id="fuelBar" class="fuel-bar"></div></div>
<div style="width:220px; height:220px; margin: 15px auto; position:relative;">
    <canvas id="fuelGauge"></canvas>
    <div id="gaugeCenter"
         style="position:absolute;
                bottom:10px;
                left:50%;
                transform:translateX(-50%);
                text-align:center;">
        <div id="gaugeLitros"
             style="font-size:22px; font-weight:700; color:#fff;">
            0.00L
        </div>
        <div style="font-size:10px; color:#888;">COMBUST√çVEL</div>
    </div>
</div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span id="dispAutonomia" style="font-size: 14px; color: #fff;">Autonomia: -- km</span>
            <span id="dispLitros" style="color: #fff; font-size: 16px; font-weight: 700;">0.00 l<span style="color: #444; font-size: 11px;">/ 4.50L</span></span>
        </div>
        <div id="fuelAlertBox" class="alert-box alert-red blink" style="display: none;">‚ö† Reserva</div>
    </div>

    <div class="session-card">
        <div class="oil-info-row">
            <div>
                <p class="label-futuristic">Troca de √ìleo em</p>
                <span id="dispOleo" style="color: #fff; font-size: 14px; font-weight: 700;">---</span>
            </div>
            <div id="oilAlert" class="alert-box blink" style="display: none; margin: 0; width: auto; padding: 6px 12px;"></div>
        </div>
    </div>
    <div class="session-card">
    <p class="label-futuristic">M√©dia Mensal</p>
    <div id="mediaMensalLista" style="margin-top:8px;"></div>
    <p style="margin-top:8px; color:#eab308; font-weight:700;">
        M√©dia Geral: <span id="mediaMensalGeral">0</span> km/m√™s
    </p>
</div>
    <hr>
    
    <div class="control-grid">
        <input type="number" step="0.1" inputmode="decimal" id="inKm" placeholder="KM ATUAL">
        <input type="number" step="0.01" inputmode="decimal" id="inLitros" placeholder="LITROS">
    </div>

    <div class="control-grid">
        <div class="checkbox-container">
            <span class="label-futuristic">Cheio?</span>
            <input type="checkbox" id="inCheio">
        </div>
        <button onclick="abastecer()" class="btn-abastecer">Abastecer</button>
    </div>

    <div class="control-grid" style="margin-bottom: 1rem;">
        <button onclick="atualizarApenasKm()" class="btn-sync">Sincronizar KM</button>
        <button onclick="trocarOleo()" style="color: #888;">Trocar √ìleo</button>
    </div>
    
    <div id="historico"></div>

<script src="./chart.min.js"></script>

    <script>
        // Registro do Service Worker
        if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').then(reg => {

    reg.onupdatefound = () => {
      const newWorker = reg.installing;

      newWorker.onstatechange = () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          mostrarAvisoAtualizacao();
        }
      };
    };

  });
}

        navigator.serviceWorker.ready.then(async (registration) => {
  if ('periodicSync' in registration) {
    try {
      await registration.periodicSync.register('verificar-alertas', {
        minInterval: 12 * 60 * 60 * 1000 // 12h
      });
    } catch (e) {
      console.log("Periodic Sync n√£o suportado");
    }
  }
});

        navigator.serviceWorker.addEventListener("message", (event) => {
  if (event.data?.type === "CHECK_ALERTS") {
    verificarAlertasLocal();
  }
});

function mostrarAvisoAtualizacao() {
  const aviso = document.createElement("div");
  aviso.style.position = "fixed";
  aviso.style.bottom = "20px";
  aviso.style.left = "50%";
  aviso.style.transform = "translateX(-50%)";
  aviso.style.background = "#111";
  aviso.style.color = "#00ff41";
  aviso.style.padding = "12px 20px";
  aviso.style.border = "1px solid #00ff41";
  aviso.style.borderRadius = "8px";
  aviso.style.zIndex = "9999";
  aviso.innerHTML = "Nova vers√£o dispon√≠vel <button style='margin-left:10px;'>Atualizar</button>";

  aviso.querySelector("button").onclick = () => {
    window.location.reload();
  };

  document.body.appendChild(aviso);
}

        const CAP_MAX = 4.5, LIMITE_RESERVA = 1.5, INT_OLEO_KM = 1000.0, INT_OLEO_DIAS = 90;
        let db = JSON.parse(localStorage.getItem('motoDB_v2')) || {
            km: 0, kmOleo: 0, dataOleo: Date.now(), litrosNoTanque: 0, historico: [], mediaSugerida: 35, ultimaAtualizacao: Date.now()
        };

        function vibrar(ms = 40) { if (navigator.vibrate) navigator.vibrate(ms); }
// URL do seu banco de dados (adicione o .json no final da URL que voc√™ copiou)
const FIREBASE_URL = "https://motopanelbackup-default-rtdb.firebaseio.com/backup_moto.json";

async function salvarBackupOnline(dados) {
    if (!navigator.onLine) return;

    try {
        const response = await fetch(FIREBASE_URL, { cache: "no-store" });
        const dadosNuvem = await response.json();

        // Se existir backup e ele for mais novo que o local, N√ÉO sobrescreve
        if (dadosNuvem && dadosNuvem.ultimaAtualizacao > dados.ultimaAtualizacao) {
            console.log("Nuvem est√° mais atual. Cancelando envio.");
            return;
        }

        await fetch(FIREBASE_URL, {
            method: 'PUT',
            body: JSON.stringify(dados),
            headers: { 'Content-Type': 'application/json' }
        });

        console.log("Backup sincronizado com sucesso.");
    } catch (e) {
        console.error("Erro no backup:", e);
    }
}
        function render() {
            const totalFixo = db.km.toFixed(1);
            const partes = totalFixo.split('.');
            document.getElementById('dispTotalKm').innerText = Math.floor(partes[0]).toLocaleString('pt-BR', { minimumIntegerDigits: 5 });
            document.getElementById('dispMeters').innerText = partes[1] || "0";
            
            const kmRestante = INT_OLEO_KM - (db.km - db.kmOleo);
// Garante que dataOleo seja n√∫mero v√°lido
const dataOleoValida = Number(db.dataOleo) || Date.now();

const diasPassados = Math.floor(
    (Date.now() - dataOleoValida) / (1000 * 60 * 60 * 24)
);

const diasRestantes = Math.max(0, INT_OLEO_DIAS - diasPassados);
            document.getElementById('dispOleo').innerText = `${kmRestante.toFixed(1)} km / ${diasRestantes} d`;

            const oilAlertBox = document.getElementById('oilAlert');
            if (kmRestante <= 0 || diasRestantes <= 0) {
                oilAlertBox.style.display = "block"; oilAlertBox.className = "alert-box alert-red blink"; oilAlertBox.innerText = "Trocar!";
            } else if (kmRestante <= 100) {
                oilAlertBox.style.display = "block"; oilAlertBox.className = "alert-box alert-yellow blink"; oilAlertBox.innerText = "‚ö†";
            } else { oilAlertBox.style.display = "none"; }

            const perc = (db.litrosNoTanque / CAP_MAX) * 100;
            const bar = document.getElementById('fuelBar');
            bar.style.width = Math.min(perc, 100) + '%';
            bar.style.backgroundColor = db.litrosNoTanque < LIMITE_RESERVA ? 'var(--warning-red)' : 'var(--neon-green)';
            document.getElementById('fuelAlertBox').style.display = db.litrosNoTanque < LIMITE_RESERVA ? "block" : "none";

            document.getElementById('dispLitros').innerText = db.litrosNoTanque.toFixed(2);
            document.getElementById('dispMedia').innerText = db.mediaSugerida.toFixed(1);
            document.getElementById('dispAutonomia').innerText = `Autonomia: ${(db.litrosNoTanque * db.mediaSugerida).toFixed(0)} km`;

            document.getElementById('historico').innerHTML = (db.historico || []).slice(0, 3).map(h => `
                <div class="history-card">
                    <div><p class="label-futuristic" style="margin:0">${new Date(h.data).toLocaleDateString()}</p><p style="color:#fff"><b>${h.km}</b> km</p></div>
                    <div style="text-align: right;"><p style="color: #eab308; font-weight: 700;">${h.litros.toFixed(2)}L</p></div>
                </div>
            `).join('');
            localStorage.setItem('motoDB_v2', JSON.stringify(db));
            // Salva na Nuvem (Em segundo plano - n√£o trava o app)

const restante = CAP_MAX - db.litrosNoTanque;

if (fuelChart) {
    const restante = CAP_MAX - db.litrosNoTanque;

    let cor = '#00ff41';
    if (db.litrosNoTanque < LIMITE_RESERVA) cor = '#dc2626';
    else if (db.litrosNoTanque < 2.5) cor = '#eab308';

    fuelChart.data.datasets[0].data = [db.litrosNoTanque, restante];
    fuelChart.data.datasets[0].backgroundColor = [cor, '#111'];
    fuelChart.update();

    document.getElementById("gaugeLitros").innerText =
        db.litrosNoTanque.toFixed(2) + "L";
}
            
        const media = calcularMediaMensal();

document.getElementById("mediaMensalGeral").innerText = 
    media.mediaGeral.toFixed(0);

document.getElementById("mediaMensalLista").innerHTML =
    media.meses.slice(-3).reverse().map(m => `
        <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px;">
            <span style="color:#888;">${m.label}</span>
            <span style="color:#fff; font-weight:700;">${m.km.toFixed(0)} km</span>
        </div>
    `).join("");
    }
async function baixarBackupOnline() {
    if (!navigator.onLine) { alert("Sem internet"); return; }
    if (!confirm("Deseja carregar os dados da nuvem? Isso substituir√° os dados locais.")) return;

    try {
        const response = await fetch(FIREBASE_URL, { cache: "no-store" });
        if (!response.ok) throw new Error("Falha na requisi√ß√£o");

        const dadosNuvem = await response.json();
        if (!dadosNuvem) {
            alert("Backup vazio");
            return;
        }

        db = {
            km: 0,
            kmOleo: 0,
            dataOleo: Date.now(),
            litrosNoTanque: 0,
            historico: [],
            mediaSugerida: 35,
            ...dadosNuvem
        };

        localStorage.setItem('motoDB_v2', JSON.stringify(db));
        render();
        alert("Sincronizado com sucesso!");

    } catch (e) {
        console.error(e);
        alert("Erro ao baixar dados.");
    }
}
        function atualizarConsumo(novoKm) {
            if (db.km > 0 && novoKm > db.km) {
                db.litrosNoTanque = Math.max(0, db.litrosNoTanque - ((novoKm - db.km) / db.mediaSugerida));
            }
            db.km = novoKm;
        }

function calcularMediaMensal() {
    if (!db.historico || db.historico.length < 2) return { meses: [], mediaGeral: 0 };

    let meses = {};

    for (let i = db.historico.length - 1; i > 0; i--) {
        const atual = db.historico[i - 1];
        const anterior = db.historico[i];

        const data = new Date(atual.data);
        const chave = `${data.getFullYear()}-${data.getMonth()}`;

        const distancia = atual.km - anterior.km;

        if (!meses[chave]) meses[chave] = 0;
        if (distancia > 0) meses[chave] += distancia;
    }

    const listaMeses = Object.entries(meses).map(([chave, km]) => {
        const [ano, mes] = chave.split("-");
        const nomeMes = new Date(ano, mes).toLocaleString('pt-BR', { month: 'long' });
        return {
            label: `${nomeMes}/${ano}`,
            km
        };
    });

    const somaTotal = listaMeses.reduce((acc, m) => acc + m.km, 0);
    const mediaGeral = listaMeses.length ? somaTotal / listaMeses.length : 0;

    return {
        meses: listaMeses,
        mediaGeral
    };
}

       let fuelChart;

function criarGauge() {
    const ctx = document.getElementById('fuelGauge').getContext('2d');

    fuelChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [0, CAP_MAX], // Litros cheios / restante
                backgroundColor: ['#00ff41', '#111'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // permite preencher o quadrado
            rotation: -Math.PI,          // inicia na esquerda
            circumference: Math.PI / 2,  // 90¬∞ do c√≠rculo
            cutout: '70%',               // raio do centro
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            },
            animation: {
                animateRotate: true,
                duration: 800
            }
        }
    });
}
        
        function abastecer() {
            vibrar(60);
            const km = parseFloat(document.getElementById('inKm').value);
            let litros = parseFloat(document.getElementById('inLitros').value) || 0;
            const cheio = document.getElementById('inCheio').checked;
            if (!km || km < db.km) return alert("KM Inv√°lido.");
            
            atualizarConsumo(km);
            if (cheio) {
                const idx = db.historico.findIndex(h => h.cheio);
                if (idx !== -1) {
                    const dist = km - db.historico[idx].km;
                    const lts = db.historico.slice(0, idx).reduce((acc, h) => acc + h.litros, 0) + (litros || (CAP_MAX - db.litrosNoTanque));
                    if (dist > 0 && lts > 0) db.mediaSugerida = (db.mediaSugerida * 0.3) + ((dist / lts) * 0.7);
                }
                db.litrosNoTanque = CAP_MAX;
            } else {
                db.litrosNoTanque = Math.min(CAP_MAX, db.litrosNoTanque + litros);
            }
            db.historico.unshift({ km, litros, cheio, data: Date.now() });
            // Mant√©m apenas os 10 primeiros itens e descarta o resto
            db.historico = db.historico.slice(0, 15);
            document.getElementById('inKm').value = ''; document.getElementById('inLitros').value = ''; 
            db.ultimaAtualizacao = Date.now();
            render();
            salvarBackupOnline(db);
        }

        function atualizarApenasKm() {
            const km = parseFloat(document.getElementById('inKm').value);
            if (km >= db.km) { atualizarConsumo(km); document.getElementById('inKm').value = ''; db.ultimaAtualizacao = Date.now(); render(); salvarBackupOnline(db); vibrar(); }
        }

        function trocarOleo() {
            vibrar(100);
            if(confirm("Confirmar troca de √≥leo?")) { db.kmOleo = db.km; db.dataOleo = Date.now(); db.ultimaAtualizacao = Date.now(); render(); salvarBackupOnline(db); }
        }

function verificarAlertasLocal() {
  const agora = Date.now();

  // ‚è± Sem atualiza√ß√£o h√° mais de 7 dias
  const diasSemAtualizar = Math.floor(
    (agora - db.ultimaAtualizacao) / (1000 * 60 * 60 * 24)
  );

  if (diasSemAtualizar >= 7) {
    mostrarNotificacao("MotoRei", "‚ö† Voc√™ n√£o atualiza h√° 7 dias.");
  }

  // üõ¢ √ìleo vencido
  const kmRestante = INT_OLEO_KM - (db.km - db.kmOleo);
  const diasPassados = Math.floor(
    (agora - db.dataOleo) / (1000 * 60 * 60 * 24)
  );

  if (kmRestante <= 0 || diasPassados >= INT_OLEO_DIAS) {
    mostrarNotificacao("MotoRei", "üõ¢ Hora de trocar o √≥leo!");
  }

  // ‚õΩ Reserva
  if (db.litrosNoTanque < LIMITE_RESERVA) {
    mostrarNotificacao("MotoRei", "‚õΩ Aten√ß√£o: combust√≠vel na reserva!");
  }
}
function mostrarNotificacao(titulo, corpo) {
  if (Notification.permission === "granted") {
    navigator.serviceWorker.ready.then(reg => {
      reg.showNotification(titulo, {
        body: corpo,
        icon: "./icon-512.png",
        badge: "./icon-512.png",
        vibrate: [200, 100, 200]
      });
    });
  }
}
        
async function solicitarPermissaoNotificacao() {
  if (!("Notification" in window)) return;

  const permissao = await Notification.requestPermission();
  if (permissao !== "granted") {
    alert("Permiss√£o de notifica√ß√£o negada.");
  }
}
        async function verificarAlertas() {
  const clientsList = await self.clients.matchAll({ type: "window" });
  if (!clientsList.length) return;

  clientsList[0].postMessage({ type: "CHECK_ALERTS" });
}
        solicitarPermissaoNotificacao();
        criarGauge();
        render();
        window.addEventListener('online', () => {
    console.log("Internet voltou. Sincronizando...");
    salvarBackupOnline(db);
});
        
    </script>
</body>
</html>
