<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MotoPanel PRO +</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background: #050505; color: #00ff41; font-family: 'Orbitron', sans-serif; }
        .lcd-panel { 
            background: linear-gradient(145deg, #101010, #050505); 
            border: 1px solid #222; 
            box-shadow: inset 0 0 30px #000;
            position: relative;
            overflow: hidden;
        }
        /* Efeito de Scanlines para cara de hardware antigo */
        .lcd-panel::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%);
            background-size: 100% 4px;
            z-index: 10;
            pointer-events: none;
        }
        .fuel-bar { transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.1; } }
        input { font-family: sans-serif !important; }
        .history-card { font-family: sans-serif; background: #111; border-left: 3px solid #eab308; }
        #dispTotalKm, #dispMedia { text-shadow: 0 0 10px rgba(0, 255, 65, 0.4); }
    </style>
</head>
<body class="p-4 flex flex-col min-h-screen max-w-md mx-auto">
    
    <div class="lcd-panel p-5 rounded-[2rem] mb-6 shadow-2xl border-gray-800">
        <div class="flex justify-between items-start mb-2 relative z-20">
            <div>
                <span class="text-[9px] text-gray-500 block uppercase">Total ODO</span>
                <span id="dispTotalKm" class="text-3xl font-bold text-white">000000</span> <span class="text-[10px] text-green-500">km</span>
            </div>
            <div class="text-right">
                <span class="text-[9px] text-gray-500 block uppercase">Consumo Médio</span>
                <span id="dispMedia" class="text-2xl font-bold text-yellow-500">0.0</span> <span class="text-[10px]">km/L</span>
            </div>
        </div>

        <div class="mb-4 relative z-20">
            <div class="w-full bg-gray-950 h-5 rounded-full border border-gray-900 p-1 flex overflow-hidden">
                <div id="fuelBar" class="fuel-bar h-full rounded-full bg-green-500 w-0"></div>
            </div>
            <div class="flex justify-between mt-2 items-baseline">
                <span id="dispAutonomia" class="text-xs font-bold text-gray-400 italic font-sans">Est: -- km</span>
                <span id="dispLitros" class="text-lg font-bold text-white">0.0<span class="text-xs text-gray-500">/4.5L</span></span>
            </div>
        </div>

        <div class="border-t border-gray-900 pt-3 flex justify-between items-center relative z-20">
            <div class="flex flex-col">
                <span class="text-[9px] text-gray-500 uppercase">Óleo / Validade:</span>
                <span id="dispOleo" class="text-sm font-bold">---</span>
            </div>
            <div id="oilAlert" class="hidden blink bg-red-950 text-red-500 px-2 py-1 rounded text-[10px] font-bold border border-red-800">TROCAR ÓLEO!</div>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-3 mb-6">
        <div class="grid grid-cols-2 gap-2">
            <input type="number" inputmode="decimal" id="inKm" placeholder="KM Atual" class="bg-gray-900 p-4 text-white border border-gray-800 rounded-xl outline-none focus:border-green-600">
            <div class="flex flex-col gap-1">
                <input type="number" inputmode="decimal" id="inLitros" placeholder="Litros" class="bg-gray-900 p-4 text-white border border-gray-800 rounded-xl outline-none focus:border-orange-600 w-full">
                <div class="flex gap-1">
                    <button onclick="addLitros(1)" class="flex-1 bg-gray-800 text-[9px] py-1 rounded border border-gray-700">+1L</button>
                    <button onclick="addLitros(2)" class="flex-1 bg-gray-800 text-[9px] py-1 rounded border border-gray-700">+2L</button>
                </div>
            </div>
        </div>
        
        <div class="flex gap-2">
            <label class="flex flex-1 items-center justify-center bg-gray-900 rounded-xl border border-gray-800 p-3 select-none active:bg-gray-800">
                <span class="text-[10px] mr-2 uppercase text-gray-400 font-sans">Tanque Cheio?</span>
                <input type="checkbox" id="inCheio" class="w-6 h-6 accent-green-600">
            </label>
            <button onclick="abastecer()" class="flex-1 bg-orange-600 text-white font-bold rounded-xl uppercase text-xs p-4 active:scale-95 transition-transform">Abastecer</button>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <button onclick="atualizarApenasKm()" class="bg-gray-800 text-gray-300 font-bold p-3 rounded-xl uppercase text-[10px]">Atualizar KM</button>
            <button onclick="trocarOleo()" class="bg-blue-800 text-white font-bold p-3 rounded-xl uppercase text-[10px]">Trocar Óleo</button>
        </div>
    </div>

    <div class="flex-grow">
        <h3 class="text-[10px] text-gray-500 uppercase mb-2 tracking-widest px-1">Últimos Abastecimentos</h3>
        <div id="historico" class="space-y-2 font-sans"></div>
        
        <div class="grid grid-cols-2 gap-2 mt-8 px-2">
            <button onclick="exportarBackup()" class="text-[9px] text-blue-500 uppercase tracking-widest border border-blue-900/30 py-2 rounded-lg">Exportar JSON</button>
            <button onclick="document.getElementById('fileInput').click()" class="text-[9px] text-purple-500 uppercase tracking-widest border border-purple-900/30 py-2 rounded-lg">Importar JSON</button>
            <input type="file" id="fileInput" class="hidden" accept=".json" onchange="importarBackup(event)">
        </div>
        <button onclick="limparDados()" class="mt-4 text-[9px] text-gray-700 uppercase w-full text-center tracking-widest pb-8">Limpar todos os dados</button>
    </div>

    <script>
        const CAP_MAX = 4.5;
        const INT_OLEO_KM = 1000;
        const INT_OLEO_DIAS = 90;

        let db = JSON.parse(localStorage.getItem('motoDB_v2')) || {
            km: 0,
            kmOleo: 0,
            dataOleo: Date.now(),
            litrosNoTanque: 0,
            historico: [],
            mediaSugerida: 35
        };

        function vibrar(ms = 40) {
            if (navigator.vibrate) navigator.vibrate(ms);
        }

        function addLitros(v) {
            vibrar(20);
            const input = document.getElementById('inLitros');
            input.value = (parseFloat(input.value) || 0) + v;
        }

        function render() {
            document.getElementById('dispTotalKm').innerText = Math.floor(db.km).toString().padStart(6, '0');
            
            // Lógica Óleo
            const kmRest = INT_OLEO_KM - (db.km - db.kmOleo);
            const diasRest = Math.ceil((db.dataOleo + (INT_OLEO_DIAS * 86400000) - Date.now()) / 86400000);
            document.getElementById('dispOleo').innerText = `${kmRest}km / ${diasRest}d`;
            document.getElementById('oilAlert').classList.toggle('hidden', kmRest > 0 && diasRest > 0);

            // Combustível
            const perc = (db.litrosNoTanque / CAP_MAX) * 100;
            const bar = document.getElementById('fuelBar');
            bar.style.width = `${Math.min(perc, 100)}%`;
            bar.className = `fuel-bar h-full rounded-full ${perc < 20 ? 'bg-red-600 blink' : 'bg-green-600'}`;
            
            document.getElementById('dispLitros').innerText = db.litrosNoTanque.toFixed(1);
            document.getElementById('dispMedia').innerText = db.mediaSugerida.toFixed(1);
            document.getElementById('dispAutonomia').innerText = `Est: ${(db.litrosNoTanque * db.mediaSugerida).toFixed(0)} km`;

            // Histórico
            const histContainer = document.getElementById('historico');
            histContainer.innerHTML = db.historico.slice(0, 5).map(h => `
                <div class="history-card p-3 rounded-lg flex justify-between items-center text-white">
                    <div class="text-xs">
                        <div class="text-gray-500 text-[9px]">${new Date(h.data).toLocaleDateString()}</div>
                        <b>${h.km} km</b>
                    </div>
                    <div class="text-right">
                        <div class="text-orange-400 font-bold text-xs">${h.litros.toFixed(2)}L</div>
                        <div class="text-[9px] text-gray-500">${h.cheio ? 'Tanque Cheio' : 'Parcial'}</div>
                    </div>
                </div>
            `).join('');

            localStorage.setItem('motoDB_v2', JSON.stringify(db));
        }

        function atualizarConsumo(novoKm) {
            if (db.km > 0 && novoKm > db.km) {
                const distancia = novoKm - db.km;
                db.litrosNoTanque = Math.max(0, db.litrosNoTanque - (distancia / db.mediaSugerida));
            }
            db.km = novoKm;
        }

        function atualizarApenasKm() {
            vibrar();
            const km = parseFloat(document.getElementById('inKm').value);
            if (!km || km < db.km) return alert("KM inválido");
            atualizarConsumo(km);
            render();
            alert("KM Atualizado!");
        }

        function abastecer() {
            vibrar(60);
            const km = parseFloat(document.getElementById('inKm').value);
            const litrosInput = parseFloat(document.getElementById('inLitros').value) || 0;
            const cheio = document.getElementById('inCheio').checked;

            if (!km || km < db.km) return alert("KM inválido");
            if (!litrosInput && !cheio) return alert("Informe os litros ou marque cheio");

            atualizarConsumo(km);

            let litrosEfetivos = litrosInput;

            if (cheio) {
                // Cálculo de quanto entrou para completar
                litrosEfetivos = (CAP_MAX - db.litrosNoTanque) + litrosInput;
                db.litrosNoTanque = CAP_MAX;

                // CÁLCULO DE MÉDIA ACUMULADA
                const idxUltimoCheio = db.historico.findIndex(h => h.cheio === true);
                if (idxUltimoCheio !== -1) {
                    const ultimoCheio = db.historico[idxUltimoCheio];
                    const distTotal = km - ultimoCheio.km;
                    const litrosParciais = db.historico.slice(0, idxUltimoCheio).reduce((acc, h) => acc + h.litros, 0);
                    const consumoTotal = litrosParciais + litrosEfetivos;

                    if (distTotal > 0 && consumoTotal > 0) {
                        const mediaReal = distTotal / consumoTotal;
                        db.mediaSugerida = (db.mediaSugerida * 0.3) + (mediaReal * 0.7);
                    }
                }
            } else {
                db.litrosNoTanque = Math.min(CAP_MAX, db.litrosNoTanque + litrosInput);
            }

            db.historico.unshift({ km, litros: litrosEfetivos, cheio, data: Date.now() });
            
            document.getElementById('inLitros').value = '';
            document.getElementById('inCheio').checked = false;
            render();
            alert("Abastecimento Salvo!");
        }

        function trocarOleo() {
            vibrar(100);
            const km = parseFloat(document.getElementById('inKm').value) || db.km;
            if(confirm("Troca de óleo no KM " + km + "?")) {
                db.kmOleo = km;
                db.dataOleo = Date.now();
                render();
            }
        }

        function exportarBackup() {
            vibrar();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", `moto_backup.json`);
            dlAnchor.click();
        }

        function importarBackup(event) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    db = JSON.parse(e.target.result);
                    render();
                    alert("Dados importados!");
                } catch { alert("Arquivo inválido"); }
            };
            reader.readAsText(event.target.files[0]);
        }

        function limparDados() {
            if(confirm("APAGAR TUDO?")) {
                localStorage.removeItem('motoDB_v2');
                location.reload();
            }
        }

        render();
    </script>
</body>
</html>
