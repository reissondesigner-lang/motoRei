<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MotoPanel PRO +</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background: #050505; color: #00ff41; font-family: 'Orbitron', sans-serif; }
        .lcd-panel { background: linear-gradient(145deg, #101010, #050505); border: 1px solid #222; box-shadow: inset 0 0 30px #000; }
        .fuel-bar { transition: width 0.8s ease-in-out; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.1; } }
        input { font-family: sans-serif !important; }
        .history-card { font-family: sans-serif; background: #111; border-left: 3px solid #eab308; }
    </style>
</head>
<body class="p-4 flex flex-col min-h-screen max-w-md mx-auto">
    
    <div class="lcd-panel p-5 rounded-[2rem] mb-6 shadow-2xl">
        <div class="flex justify-between items-start mb-2">
            <div>
                <span class="text-[9px] text-gray-500 block uppercase">Total ODO</span>
                <span id="dispTotalKm" class="text-3xl font-bold text-white">000000</span> <span class="text-[10px] text-green-500">km</span>
            </div>
            <div class="text-right">
                <span class="text-[9px] text-gray-500 block uppercase">Média</span>
                <span id="dispMedia" class="text-2xl font-bold text-yellow-500">0.0</span> <span class="text-[10px]">km/L</span>
            </div>
        </div>

        <div class="mb-4">
            <div class="w-full bg-gray-950 h-5 rounded-full border border-gray-800 p-1 flex overflow-hidden">
                <div id="fuelBar" class="fuel-bar h-full rounded-full bg-green-500 w-0"></div>
            </div>
            <div class="flex justify-between mt-2 items-baseline">
                <span id="dispAutonomia" class="text-xs font-bold text-gray-400 italic font-sans">Est: -- km</span>
                <span id="dispLitros" class="text-lg font-bold text-white">0.0<span class="text-xs text-gray-500">/4.5L</span></span>
            </div>
        </div>

        <div class="border-t border-gray-900 pt-3 flex justify-between items-center">
            <div class="flex flex-col">
                <span class="text-[9px] text-gray-500 uppercase">Óleo em:</span>
                <span id="dispOleo" class="text-sm font-bold">---</span>
            </div>
            <div id="oilAlert" class="hidden blink bg-red-950 text-red-500 px-2 py-1 rounded text-[10px] font-bold border border-red-800">TROCAR ÓLEO!</div>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-3 mb-6">
        <div class="grid grid-cols-2 gap-2">
            <input type="number" id="inKm" placeholder="KM Atual" class="bg-gray-900 p-4 text-white border border-gray-800 rounded-xl outline-none focus:border-green-600">
            <input type="number" id="inLitros" placeholder="Litros" class="bg-gray-900 p-4 text-white border border-gray-800 rounded-xl outline-none focus:border-orange-600">
        </div>
        
        <div class="flex gap-2">
            <label class="flex flex-1 items-center justify-center bg-gray-900 rounded-xl border border-gray-800 p-3 select-none">
                <span class="text-[10px] mr-2 uppercase text-gray-400 font-sans">Tanque Cheio?</span>
                <input type="checkbox" id="inCheio" class="w-5 h-5 accent-green-600">
            </label>
            <button onclick="abastecer()" class="flex-1 bg-orange-600 text-white font-bold rounded-xl uppercase text-xs p-4">Abastecer</button>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <button onclick="atualizarApenasKm()" class="bg-gray-800 text-gray-300 font-bold p-3 rounded-xl uppercase text-[10px]">Atualizar KM</button>
            <button onclick="trocarOleo()" class="bg-blue-800 text-white font-bold p-3 rounded-xl uppercase text-[10px]">Trocar Óleo</button>
        </div>
    </div>

    <div class="flex-grow">
        <h3 class="text-[10px] text-gray-500 uppercase mb-2 tracking-widest px-1">Últimos Abastecimentos</h3>
        <div id="historico" class="space-y-2 font-sans"></div>
        <button onclick="limparDados()" class="mt-8 text-[9px] text-gray-700 uppercase w-full text-center tracking-widest">Limpar todos os dados</button>
    </div>

    <script>
        const CAP_MAX = 4.5;
        const INT_OLEO_KM = 1000;
        const INT_OLEO_DIAS = 90;

        // Inicialização do Banco de Dados Local
        let db = JSON.parse(localStorage.getItem('motoDB_v2')) || {
            km: 0,
            kmOleo: 0,
            dataOleo: Date.now(),
            litrosNoTanque: 0,
            historico: [],
            mediaSugerida: 35
        };

        function render() {
            document.getElementById('dispTotalKm').innerText = Math.floor(db.km).toString().padStart(6, '0');
            
            // Lógica Óleo
            const kmRest = INT_OLEO_KM - (db.km - db.kmOleo);
            const diasRest = Math.ceil((db.dataOleo + (INT_OLEO_DIAS * 86400000) - Date.now()) / 86400000);
            document.getElementById('dispOleo').innerText = `${kmRest}km / ${diasRest}d`;
            document.getElementById('oilAlert').classList.toggle('hidden', kmRest > 0 && diasRest > 0);

            // Combustível
            const perc = (db.litrosNoTanque / CAP_MAX) * 100;
            const bar = document.getElementById('fuelBar');
            bar.style.width = `${Math.min(perc, 100)}%`;
            bar.className = `fuel-bar h-full rounded-full ${perc < 25 ? 'bg-red-600 blink' : 'bg-green-600'}`;
            
            document.getElementById('dispLitros').innerText = db.litrosNoTanque.toFixed(1);
            document.getElementById('dispMedia').innerText = db.mediaSugerida.toFixed(1);
            document.getElementById('dispAutonomia').innerText = `Est: ${(db.litrosNoTanque * db.mediaSugerida).toFixed(0)} km`;

            // Histórico
            const histContainer = document.getElementById('historico');
            histContainer.innerHTML = db.historico.slice(0, 5).map(h => `
                <div class="history-card p-3 rounded-lg flex justify-between items-center text-white">
                    <div class="text-xs">
                        <div class="text-gray-500 text-[9px]">${new Date(h.data).toLocaleDateString()}</div>
                        <b>${h.km} km</b>
                    </div>
                    <div class="text-right">
                        <div class="text-orange-400 font-bold text-xs">${h.litros.toFixed(2)}L</div>
                        <div class="text-[9px] text-gray-500">${h.cheio ? 'Tanque Cheio' : ''}</div>
                    </div>
                </div>
            `).join('');

            localStorage.setItem('motoDB_v2', JSON.stringify(db));
        }

        function atualizarConsumo(novoKm) {
            if (db.km > 0 && novoKm > db.km) {
                const distancia = novoKm - db.km;
                db.litrosNoTanque = Math.max(0, db.litrosNoTanque - (distancia / db.mediaSugerida));
            }
            db.km = novoKm;
        }

        function atualizarApenasKm() {
            const km = parseFloat(document.getElementById('inKm').value);
            if (!km || km < db.km) return alert("KM inválido");
            atualizarConsumo(km);
            render();
            alert("KM Atualizado!");
        }

        function abastecer() {
            const km = parseFloat(document.getElementById('inKm').value);
            const litrosInput = parseFloat(document.getElementById('inLitros').value) || 0;
            const cheio = document.getElementById('inCheio').checked;

            if (!km) return alert("Insira o KM atual para abastecer");
            if (km < db.km) return alert("KM menor que o anterior");
            if (!litrosInput && !cheio) return alert("Informe os litros ou marque cheio");

            // 1. Atualiza o consumo pelo trajeto antes de colocar gasolina
            atualizarConsumo(km);

            // 2. Calcula litros inseridos
            let litrosAdicionados = litrosInput;
            if (cheio) {
                litrosAdicionados = CAP_MAX - db.litrosNoTanque;
                db.litrosNoTanque = CAP_MAX;
            } else {
                db.litrosNoTanque = Math.min(CAP_MAX, db.litrosNoTanque + litrosInput);
            }

            // 3. Cálculo de média (se encheu o tanque e tem histórico)
            if (cheio && db.historico.length > 0 && db.historico[0].cheio) {
                const dist = km - db.historico[0].km;
                if (dist > 0) {
                    const novaMedia = dist / litrosAdicionados;
                    db.mediaSugerida = (db.mediaSugerida * 0.4) + (novaMedia * 0.6); // Média ponderada
                }
            }

            // 4. Salva no histórico
            db.historico.unshift({ km, litros: litrosAdicionados, cheio, data: Date.now() });
            
            render();
            document.getElementById('inLitros').value = '';
            alert("Abastecimento Salvo!");
        }

        function trocarOleo() {
            const km = parseFloat(document.getElementById('inKm').value) || db.km;
            if(confirm("Registrar troca de óleo no KM " + km + "?")) {
                db.kmOleo = km;
                db.dataOleo = Date.now();
                render();
            }
        }

        function limparDados() {
            if(confirm("APAGAR TUDO?")) {
                localStorage.removeItem('motoDB_v2');
                location.reload();
            }
        }

        render();
    </script>
</body>
</html>
